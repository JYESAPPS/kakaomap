<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <title>주소 찾기</title>
  <meta name="viewport" content="width=device-width,height=device-height,initial-scale=1.0" />
  <!-- 권장 최신 스크립트 경로 -->
  <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
  <style>
    html,
    body {
      height: 100%;
      margin: 0;
    }

    #layer {
      position: absolute;
      inset: 0;
      overflow: hidden;
      -webkit-overflow-scrolling: touch;
      z-index: 1;
    }
  </style>
</head>

<body onload="execDaumPostcode()">
  <div id="layer"></div>

  <script>
    const url = new URL(location.href);
    const INAPP = url.searchParams.get('inapp') === '1';         // ← 인앱 표식
    const APP_ORIGIN = (() => {
      try {
        // 인앱 iframe의 부모 URL이 referrer로 들어옵니다.
        const r = document.referrer ? new URL(document.referrer).origin : "";
        return r || "http://wizmarket.ai";
      } catch { return "http://wizmarket.ai"; }
    })();
    const RETURN_URL = url.searchParams.get('return') || "";     // ← 단독(비-inapp) 사용 시만
    const layer = document.getElementById('layer');

    document.getElementById('closeBtn').addEventListener('click', () => {
      if (INAPP) {
        // 인앱: 부모에게 닫힘 신호만 보냄 (리다이렉트 금지)
        window.parent.postMessage({ type: 'POSTCODE_CLOSED' }, APP_ORIGIN);
        return;
      }
      // 단독: 뒤로가기/리턴URL/레이어 숨김
      if (history.length > 1) { history.back(); return; }
      if (RETURN_URL) { location.replace(RETURN_URL + '#closed=1'); return; }
      document.getElementById('layer').style.display = 'none';
    });

    function execDaumPostcode() {
      new daum.Postcode({
        oncomplete: function (data) {
          const road = data.roadAddress || data.jibunAddress || data.autoRoadAddress || "";
          const zip = data.zonecode || "";

          if (INAPP) {
            // 인앱: 오직 postMessage만! (리다이렉트 금지)
            window.parent.postMessage({ type: 'POSTCODE_SELECTED', road, zip }, APP_ORIGIN);
            return;
          }
          // 단독 사용 시: RETURN_URL로 해시 전달
          if (RETURN_URL) {
            location.replace(RETURN_URL + '#road=' + encodeURIComponent(road) + '&zip=' + encodeURIComponent(zip));
            return;
          }

          alert("return URL이 없습니다. ?return=... 을 확인해 주세요.");
        },
        width: "100%",
        height: "100%"
      }).embed(document.getElementById('layer'));
    }
  </script>
</body>

</html>