<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <title>주소 찾기</title>
  <meta name="viewport" content="width=device-width,height=device-height,initial-scale=1.0" />
  <!-- 권장 최신 스크립트 경로 -->
  <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
  <style>
    html,
    body {
      height: 100%;
      margin: 0;
    }

    #layer {
      position: absolute;
      inset: 0;
      overflow: hidden;
      -webkit-overflow-scrolling: touch;
      z-index: 1;
    }

    /* 닫기 버튼(옵션) */
    #closeBtn {
      position: fixed;
      top: calc(60px + env(safe-area-inset-top, 0px));
      right: 12px;
      width: 40px;
      height: 40px;
      border-radius: 9999px;
      border: none;
      background: rgba(0, 0, 0, .65);
      color: #fff;
      font-size: 22px;
      line-height: 40px;
      z-index: 9999;
      cursor: pointer;
    }

    #closeBtn:focus {
      outline: 2px solid #7864F9;
    }
  </style>
</head>

<body onload="execDaumPostcode()">
  <button id="closeBtn" aria-label="닫기" title="닫기">×</button>
  <div id="layer"></div>

  <script>
    // 부모 앱 오리진 (환경에 맞춰 http/https 정확히!)
    // 운영이 http라면 아래처럼 고정:
    const APP_ORIGIN = "http://wizmarket.ai";
    // 운영이 https로 바뀌면: const APP_ORIGIN = "https://wizmarket.ai";

    const layer = document.getElementById("layer");

    // In-App(iframe) 여부
    const inIframe = (() => {
      try { return window.self !== window.top; } catch { return true; }
    })();

    function getReturnUrl() {
      try { return new URL(location.href).searchParams.get("return") || ""; }
      catch { return ""; }
    }

    // 닫기(옵션)
    document.getElementById("closeBtn").addEventListener("click", () => {
      // 팝업으로 열렸다면 닫기
      if (window.opener && !window.opener.closed) { window.close(); return; }
      // 뒤로가기 가능하면 뒤로
      if (history.length > 1) { history.back(); return; }
      // return 파라미터 있으면 그쪽으로
      const ret = getReturnUrl();
      if (ret) { location.replace(ret + "#closed=1"); return; }
      // 최후수단: 레이어 숨김
      layer.style.display = "none";
    });

    function execDaumPostcode() {
      new daum.Postcode({
        oncomplete: function (data) {
          const road = data.roadAddress || data.jibunAddress || data.autoRoadAddress || "";
          const zip = data.zonecode || "";

          if (inIframe) {
            // ✅ In-App(iframe)로 열린 경우: 부모 앱으로 postMessage
            // AdsInApp.jsx가 이 메시지만 조건부로 수신합니다.
            window.parent.postMessage(
              { type: "POSTCODE_SELECTED", road, zip },
              APP_ORIGIN
            );
            return;
          }

          // ✅ 단독으로 열린 경우: return= 으로 직접 복귀 (해시로 값 전달)
          const ret = getReturnUrl();
          if (ret) {
            const target = ret + "#road=" + encodeURIComponent(road) + "&zip=" + encodeURIComponent(zip);
            // 기록 남기지 않게 replace 권장
            location.replace(target);
            return;
          }

          alert("return URL이 없습니다. ?return=... 을 확인해 주세요.");
        },
        width: "100%",
        height: "100%"
      }).embed(layer);
    }
  </script>
</body>

</html>